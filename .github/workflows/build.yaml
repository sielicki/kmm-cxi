name: Build SHS Kernel Modules

on:
  push:
    branches: [main, master]
    paths:
      - 'dockerfiles/**'
      - 'scripts/**'
      - 'docker-bake.hcl'
      - 'flake.lock'
      - '.github/workflows/build.yaml'
  pull_request:
    branches: [main, master]
  workflow_dispatch:
  schedule:
    - cron: '0 6 * * 1'

env:
  REGISTRY: ghcr.io/${{ github.repository_owner }}

jobs:
  discover:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
      env-vars: ${{ steps.kernels.outputs.env-vars }}
    steps:
      - uses: actions/checkout@v4

      - name: Discover kernel versions
        id: kernels
        run: |
          chmod +x ./scripts/*.sh
          {
            echo 'env-vars<<EOF'
            ./scripts/bake-env.sh
            echo 'EOF'
          } >> "$GITHUB_OUTPUT"

      - name: Set matrix
        id: set-matrix
        run: |
          if [[ "${{ github.event_name }}" == "pull_request" ]]; then
            # Build all targets on PR
            echo 'matrix={"target":["el9","alma9","kitten","ubuntu2404","ubuntu2204","ubuntu2004","debian12","fc39","fc40","fc41","fc42","fc43","rawhide","leap156","tumbleweed"]}' >> "$GITHUB_OUTPUT"
          else
            # Split stable vs experimental for non-PR
            echo 'matrix={"target":["el9","alma9","ubuntu2404","ubuntu2204","ubuntu2004","debian12","fc39","fc40","fc41","fc42","fc43","rawhide","leap156","tumbleweed"]}' >> "$GITHUB_OUTPUT"
          fi

  build:
    needs: discover
    runs-on: ubuntu-latest
    permissions:
      contents: read
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.discover.outputs.matrix) }}
    steps:
      - uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Set environment variables
        run: |
          echo '${{ needs.discover.outputs.env-vars }}' >> "$GITHUB_ENV"

      - name: Build ${{ matrix.target }}
        uses: docker/bake-action@v5
        with:
          files: docker-bake.hcl
          targets: ${{ matrix.target }}
          push: false
          load: true
          set: |
            *.cache-from=type=gha,scope=${{ matrix.target }}
            *.cache-to=type=gha,scope=${{ matrix.target }},mode=max
        env:
          REGISTRY: ${{ env.REGISTRY }}

      - name: Verify modules
        run: |
          IMAGE="${{ env.REGISTRY }}/shs-kmod:latest-${{ matrix.target }}"
          if docker image inspect "$IMAGE" &>/dev/null; then
            echo "Modules built:"
            docker run --rm "$IMAGE" sh -c 'ls -la /opt/lib/modules/*/*.ko 2>/dev/null || echo "No modules found"'
          else
            echo "Image not found: $IMAGE"
            exit 1
          fi

  summary:
    needs: build
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Build summary
        run: |
          echo "## Build Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Target | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|--------|" >> $GITHUB_STEP_SUMMARY
          echo '${{ toJson(needs.build) }}' | jq -r '
            .result as $overall |
            if $overall == "success" then "All builds passed"
            elif $overall == "failure" then "Some builds failed"
            else "Build status: \($overall)"
            end
          ' >> $GITHUB_STEP_SUMMARY
